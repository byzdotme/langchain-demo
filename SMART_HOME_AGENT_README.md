# 智能家居助手 Agent 使用指南

## 项目概述

这是一个基于 LangChain 的智能家居助手 Agent 实现，能够理解并执行复合指令。Agent 采用 ReAct（推理-行动）循环模式，可以自主决定调用不同的工具来完成用户的复杂任务。

## 功能特性

### 🔧 智能工具集
- **天气查询工具**: 获取指定城市的天气信息
- **灯光控制工具**: 控制不同房间的智能灯光开关
- **设备状态查询工具**: 查询智能家居设备的当前状态

### 🧠 Agent 能力
- **复合指令理解**: 能将复杂指令分解为多个步骤
- **自主决策**: 根据用户需求选择合适的工具
- **上下文维护**: 在多步操作中保持逻辑连贯性
- **中文交互**: 提供友好的中文对话体验

## 技术架构

### ReAct 循环机制
```
👤 用户输入
    ↓
🤔 推理分析 (Reasoning)
    ↓
🛠️ 工具调用 (Acting)
    ↓
👀 观察结果 (Observation)
    ↓
🔄 继续循环或完成任务
```

### 核心组件
- **LLM**: 使用 Ollama 本地模型 (llama3.1:8b)
- **工具系统**: 基于 LangChain Tools
- **Agent**: 使用 OpenAI Functions Agent 架构
- **执行器**: AgentExecutor 管理完整流程

## 安装和运行

### 前置要求
1. **安装 Ollama**: 确保你的系统已安装 [Ollama](https://ollama.ai/)
2. **下载模型**: 运行 `ollama pull llama3.1:8b`
3. **Node.js**: 确保 Node.js 版本 >= 16

### 运行步骤
```bash
# 1. 安装依赖
npm install

# 2. 启动智能家居助手
npm run start_smart_home

# 或者直接运行
npx ts-node -r dotenv/config src/smart_home_agent.ts
```

## 使用示例

### 复合指令示例
```
用户: "请检查卧室灯的状态，如果是关闭的就打开它，然后告诉我东京的天气"

Agent 执行流程:
1. 🔍 调用设备状态查询工具检查卧室灯
2. 💡 根据状态决定是否需要开灯
3. 🌤️ 调用天气查询工具获取东京天气
4. 💬 整合信息并回复用户
```

### 其他指令示例
- "北京现在的天气怎么样？"
- "把客厅和厨房的灯都打开"
- "关闭所有房间的灯，然后查询上海的天气"

## 自定义配置

### 修改模型设置
在 `src/smart_home_agent.ts` 中调整：
```typescript
const model = new ChatOllama({
  model: "你的模型名称", // 例如: "llama2", "codellama"
  temperature: 0.1,
});
```

### 添加新工具
1. 创建工具类或使用 DynamicTool
2. 添加到 tools 数组
3. 在系统提示中描述新功能

### 调整 Agent 行为
修改 ChatPromptTemplate 中的系统提示来调整 Agent 的行为模式。

## 代码结构说明

```
src/smart_home_agent.ts
├── 📦 工具定义部分
│   ├── getWeatherTool (天气查询)
│   ├── LightControlTool (灯光控制)
│   └── checkDeviceStatusTool (设备状态)
├── 🤖 Agent 配置部分
│   ├── 模型配置
│   ├── 工具列表
│   └── 提示模板
└── ⚡ 执行部分
    ├── Agent 创建
    ├── AgentExecutor 配置
    └── 测试场景运行
```

## 注意事项

1. **模型依赖**: 确保 Ollama 正在运行且已下载相应模型
2. **工具模拟**: 当前工具都是模拟实现，实际项目中需要连接真实设备
3. **网络要求**: 如果使用在线模型 API，请确保网络连接正常
4. **性能考虑**: 本地模型响应速度取决于硬件配置

## 扩展建议

- 添加更多智能家居设备控制工具
- 集成真实的 IoT 设备 API
- 实现语音识别和语音合成
- 添加设备状态的持久化存储
- 支持定时任务和自动化场景

## 故障排除

### 常见问题
1. **模型无响应**: 检查 Ollama 服务是否正常运行
2. **工具调用失败**: 查看详细错误日志，检查工具参数
3. **内存不足**: 考虑使用较小的模型或增加系统内存

### 调试技巧
- 启用 `verbose: true` 查看详细执行日志
- 检查 agent_scratchpad 中的推理过程
- 验证工具的 description 是否清晰准确 